<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì»´êµ AI ë²ˆí˜¸íŒ…</title>
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />

    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Pretendard', 'Inter', 'Noto Sans KR', sans-serif; }
        
        .chat-bubble-ai {
            background-color: #dbeafe; /* blue-100 */
            color: #1e40af; /* blue-800 */
            border: 1px solid #bfdbfe; /* blue-200 */
            border-bottom-left-radius: 0.25rem; /* 4px */
            border-bottom-right-radius: 1.5rem;
            border-top-left-radius: 1.5rem;
            border-top-right-radius: 1.5rem;
        }
        .chat-bubble-user {
            background-color: #fdf2f8; /* pink-50 */
            color: #be185d; /* pink-700 */
            border: 1px solid #fbcfe8; /* pink-200 */
            border-bottom-left-radius: 1.5rem;
            border-bottom-right-radius: 0.25rem; /* 4px */
            border-top-left-radius: 1.5rem;
            border-top-right-radius: 1.5rem;
        }

        .loading-spinner {
            border: 4px solid #f3f4f6; /* gray-100 */
            border-top: 4px solid #ec4899; /* pink-500 */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }
        #btn-send-answer:disabled {
            background-color: #f3f4f6; /* gray-100 */
            cursor: not-allowed;
        }
        #btn-send-answer:disabled svg {
            fill: #9ca3af; /* gray-400 */
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="main-container" class="relative container mx-auto max-w-xl lg:max-w-3xl p-8 my-8 bg-white rounded-xl shadow-2xl min-h-[85vh] flex flex-col transition-all duration-300">

        <button id="btn-fullscreen" class="absolute top-8 right-8 p-2 rounded-full text-gray-400 hover:text-gray-700 hover:bg-gray-100 transition-all duration-300 z-10">
            <svg id="icon-expand" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
              <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 3.75v4.5m0-4.5h4.5m-4.5 0L9 9M3.75 20.25v-4.5m0 4.5h4.5m-4.5 0L9 15M20.25 3.75h-4.5m4.5 0v4.5m0-4.5L15 9m5.25 11.25h-4.5m4.5 0v-4.5m0 4.5L15 15" />
            </svg>
            <svg id="icon-contract" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 hidden">
              <path stroke-linecap="round" stroke-linejoin="round" d="M9 9V4.5M9 9H4.5M9 9L3.75 3.75M9 15v4.5M9 15H4.5M9 15l-5.25 5.25M15 9h4.5M15 9V4.5M15 9l5.25-5.25M15 15h4.5M15 15v4.5M15 15l5.25 5.25" />
            </svg>
        </button>

        <div id="page-welcome" class="page-container text-center flex flex-col justify-center items-center h-full flex-grow">
            
            <h1 class="text-5xl font-bold text-pink-500 mt-5 mb-7">AI ëŸ¬ë¸Œ ë§¤ì¹­ ì„¼í„° ğŸ’˜</h1>
            
            <div class="my-5">
                <p class="text-2xl font-semibold text-gray-700">2025 ì˜ˆë¹„êµì‚¬í˜ìŠ¤í‹°ë²Œ</p>
                <p class="text-xl font-bold text-pink-400">X</p>
                <p class="text-2xl font-semibold text-gray-700">COMEDU</p>
            </div>

            <p class="text-xl mb-5 font-semibold text-gray-700">
                ì•ˆë…•í•˜ì„¸ìš”! ì»´í“¨í„°êµìœ¡ê³¼ .COM í•™ìƒíšŒì…ë‹ˆë‹¤!
            </p>

            <p class="text-xl text-gray-600 mb-5">
                Gemini 2.5 Flashê°€ ë‹¹ì‹ ì˜ ë‹µë³€ì„ ë¶„ì„í•˜ì—¬<br>ê°€ì¥ ì˜ ë§ëŠ” ìƒëŒ€ë¥¼ ì°¾ì•„ë“œë¦½ë‹ˆë‹¤!
            </p>

            <div class="w-full mt-4 mb-10 p-5 border border-pink-200 bg-pink-50 rounded-lg text-center">
                <p class="font-semibold text-pink-800 text-lg">ğŸ’° ê°•ìˆ˜í›ˆ / ì¹´ì¹´ì˜¤ë±…í¬ / 3333-32-7115949 ğŸ’°</p>
                <p class="text-pink-700 mt-1">ë²ˆí˜¸ í•˜ë‚˜ë‹¹ 500ì›! ì¸ë‹¹ ìµœëŒ€ 3ê°œğŸ¤—</p>
            </div>
            
            <button id="btn-start" class="w-full bg-pink-500 hover:bg-pink-600 text-white font-bold py-5 px-6 rounded-full text-xl shadow-lg transition duration-400 mt-4">
                ì‹œì‘í•˜ê¸°
            </button>
        </div>

        <div id="page-options" class="page-container space-y-8 hidden flex-grow">
            <h2 class="text-3xl font-semibold text-gray-700">ë§¤ì¹­ ì„¤ì •</h2>
            
            <div>
                <label class="block text-xl font-medium text-gray-700 mb-3">1. ì°¾ê³  ì‹¶ì€ ìƒëŒ€ì˜ ì„±ë³„ì€?</label>
                <fieldset class="grid grid-cols-2 gap-4">
                    <label class="flex items-center justify-center p-4 bg-gray-50 border border-gray-200 rounded-lg cursor-pointer hover:bg-gray-100 has-[:checked]:bg-blue-50 has-[:checked]:border-blue-300">
                        <input type="radio" name="targetGender" value="ë‚¨ì" class="h-5 w-5 text-blue-600 border-gray-300 focus:ring-blue-500">
                        <span class="ml-3 text-gray-700 text-lg font-medium">ë‚¨ì ğŸ‘¨ğŸ»</span>
                    </label>
                    <label class="flex items-center justify-center p-4 bg-gray-50 border border-gray-200 rounded-lg cursor-pointer hover:bg-gray-100 has-[:checked]:bg-pink-50 has-[:checked]:border-pink-300">
                        <input type="radio" name="targetGender" value="ì—¬ì" class="h-5 w-5 text-pink-600 border-gray-300 focus:ring-pink-500">
                        <span class="ml-3 text-gray-700 text-lg font-medium">ì—¬ì ğŸ‘©ğŸ»</span>
                    </label>
                </fieldset>
            </div>

            <div>
                <label class="block text-xl font-medium text-gray-700 mb-3">2. ì°¾ê³  ì‹¶ì€ ìƒëŒ€ì˜ í•™ë²ˆì€?</label>
                <fieldset class="grid grid-cols-3 gap-3">
                    <label class="flex items-center justify-center p-4 bg-gray-50 border border-gray-200 rounded-lg cursor-pointer hover:bg-gray-100 has-[:checked]:bg-pink-50 has-[:checked]:border-pink-300">
                        <input type="radio" name="targetStudentId" value="all" class="sr-only" checked> 
                        <span class="text-gray-700 text-lg font-medium">ìƒê´€ ì—†ìŒ</span>
                    </label>
                    <label class="flex items-center justify-center p-4 bg-gray-50 border border-gray-200 rounded-lg cursor-pointer hover:bg-gray-100 has-[:checked]:bg-pink-50 has-[:checked]:border-pink-300">
                        <input type="radio" name="targetStudentId" value="high" class="sr-only">
                        <span class="text-gray-700 text-lg font-medium">ğŸ“ ê³ í•™ë²ˆ(23~)</span>
                    </label>
                    <label class="flex items-center justify-center p-4 bg-gray-50 border border-gray-200 rounded-lg cursor-pointer hover:bg-gray-100 has-[:checked]:bg-pink-50 has-[:checked]:border-pink-300">
                        <input type="radio" name="targetStudentId" value="low" class="sr-only">
                        <span class="text-gray-700 text-lg font-medium">ğŸ£ ì €í•™ë²ˆ(24,25)</span>
                    </label>
                </fieldset>
            </div>

            <div>
                <label class="block text-xl font-medium text-gray-700 mb-3">3. ëª‡ ëª…ì„ ë½‘ì•„ë³¼ê¹Œìš”?</label>
                <fieldset class="grid grid-cols-3 gap-3">
                    <label class="flex items-center justify-center p-4 bg-gray-50 border border-gray-200 rounded-lg cursor-pointer hover:bg-gray-100 has-[:checked]:bg-pink-50 has-[:checked]:border-pink-300">
                        <input type="radio" name="targetCount" value="1" class="sr-only" checked> 
                        <span class="text-gray-700 text-lg font-medium">1ëª…</span>
                    </label>
                    <label class="flex items-center justify-center p-4 bg-gray-50 border border-gray-200 rounded-lg cursor-pointer hover:bg-gray-100 has-[:checked]:bg-pink-50 has-[:checked]:border-pink-300">
                        <input type="radio" name="targetCount" value="2" class="sr-only">
                        <span class="text-gray-700 text-lg font-medium">2ëª…</span>
                    </label>
                    <label class="flex items-center justify-center p-4 bg-gray-50 border border-gray-200 rounded-lg cursor-pointer hover:bg-gray-100 has-[:checked]:bg-pink-50 has-[:checked]:border-pink-300">
                        <input type="radio" name="targetCount" value="3" class="sr-only">
                        <span class="text-gray-700 text-lg font-medium">3ëª…</span>
                    </label>
                </fieldset>
            </div>

            <button id="btn-submit-options" class="w-full bg-pink-500 hover:bg-pink-600 text-white font-bold py-5 px-6 rounded-full text-lg shadow-lg transition duration-300 mt-8">
                ë‹¤ ì„ íƒí–ˆì–´ìš”! (AI ì§ˆë¬¸ ì‹œì‘)
            </button>
        </div>

        <div id="page-chat" class="page-container flex flex-col h-full flex-grow hidden" style="min-height: 60vh;">
            <h2 class="text-3xl font-semibold text-gray-700 mb-4 text-center">AI ë§¤ì¹­ ì§ˆë¬¸</h2>
            <div id="chat-window" class="flex-grow bg-gray-50 p-4 rounded-lg overflow-y-auto mb-4 space-y-4">
                </div>
            
            <div id="chat-input-container">
                <div id="chat-input-area" class="flex items-center p-2 bg-gray-100 rounded-full shadow-sm border border-gray-200">
                    <textarea id="chat-input" rows="1" 
                        class="flex-grow py-3 px-5 bg-transparent border-none rounded-full resize-none focus:ring-0 text-base"
                        placeholder="Geminiì—ê²Œ ë‹µë³€í•˜ê¸° (100ì ì´ë‚´)"
                        oninput="this.style.height = 'auto'; this.style.height = (this.scrollHeight) + 'px';"></textarea>
                    
                    <button id="btn-send-answer" class="bg-pink-500 hover:bg-pink-600 text-white rounded-full p-3 m-1 shadow transition duration-300 flex-shrink-0" disabled>
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-6 h-6">
                          <path d="M3.105 3.105a.75.75 0 01.884-.043l11.25 6.25a.75.75 0 010 1.372l-11.25 6.25a.75.75 0 01-.884-.043.75.75 0 01-.192-.838l2.29-6.361-2.29-6.361a.75.75 0 01.192-.838z" />
                        </svg>
                    </button>
                </div>
                <div class="flex justify-end text-sm text-gray-400 pr-2 mt-2">
                    <span id="char-counter">0</span> / 100
                </div>
            </div>
        </div>

        <div id="page-loading" class="page-container text-center flex flex-col justify-center items-center h-full flex-grow hidden" style="min-height: 60vh;">
            <div class="loading-spinner mb-6"></div>
            <h2 class="text-3xl font-semibold text-pink-500">AIê°€ ë§¤ì¹­ì¤‘ì…ë‹ˆë‹¤...</h2>
            <p class="text-gray-600 mt-2 text-lg">ì¡°ê±´ì— ë§ëŠ” ìƒëŒ€ë¥¼ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤.<br>ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”!</p>
        </div>

        <div id="page-result" class="page-container hidden flex-grow">
            <h2 id="result-title" class="text-3xl font-bold text-center text-pink-500 mb-6">ğŸ‰ ë§¤ì¹­ ê²°ê³¼! ğŸ‰</h2>
            
            <p id="auto-home-timer" class="text-center text-pink-500 font-semibold text-lg mb-4 hidden"></p>
            
            <div id="result-cards" class="space-y-4">
                </div>
            
            <button id="btn-go-home" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-5 px-6 rounded-full text-lg shadow-lg transition duration-300 mt-8">
                í™ˆìœ¼ë¡œ ëŒì•„ê°€ê¸°
            </button>
        </div>

        <footer class="text-center text-gray-400 text-sm mt-8 border-t pt-4">
            <p>Â© 2025 KNU Dept. of Computer Education. All rights reserved.<br><br>
                Core Concept & Initial Dev: Wang H.W.<br>
                Advanced System & UI Enhancement: Kim D.H.</p>

            <div id="total-picks-container" class="mt-1">
                <span id="total-picks-counter" class="font-medium text-pink-500">ì§‘ê³„ ì¤‘...</span>
            </div>
        </footer>
    </div>

    <script type="module">
        // -----------------------------------------------------------------
        // 1. Firebase SDK ì„í¬íŠ¸ (ë³€ê²½ ì—†ìŒ)
        // -----------------------------------------------------------------
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getFirestore, collection, query, where, getDocs, doc, 
            updateDoc, increment, setLogLevel, 
            onSnapshot 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // -----------------------------------------------------------------
        // 2. API í‚¤ (ë³€ê²½ ì—†ìŒ - ë³¸ì¸ í‚¤ ì‚¬ìš©)
        // -----------------------------------------------------------------
        
        const firebaseConfig = {
            apiKey: "AIzaSyCOVAUxum8gLD8RHtlEOb4fK80JZzljJvE",
            authDomain: "numberting-b9a32.firebaseapp.com",
            projectId: "numberting-b9a32",
            storageBucket: "numberting-b9a32.firebasestorage.app",
            messagingSenderId: "1032424015189",
            appId: "1:1032424015189:web:d9bb076f20ab73379d1bdc",
        };

        // [ìˆ˜ì •ë¨] GEMINI_API_KEY ë³€ìˆ˜ ì‚­ì œ
        // (Netlify í•¨ìˆ˜ì—ì„œ í™˜ê²½ ë³€ìˆ˜ë¡œ ê´€ë¦¬ë©ë‹ˆë‹¤)

        // -----------------------------------------------------------------
        // 3. Firebase ì´ˆê¸°í™” (ë³€ê²½ ì—†ìŒ)
        // -----------------------------------------------------------------
        let app, db, auth;
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            await signInAnonymously(auth);
            console.log("Firebase ìµëª… ë¡œê·¸ì¸ ì„±ê³µ!");

        } catch (error) {
            console.error("Firebase ì´ˆê¸°í™” ë˜ëŠ” ìµëª… ë¡œê·¸ì¸ ì‹¤íŒ¨:", error);
            alert("ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. API í‚¤ê°€ ì˜¬ë¥¸ì§€ í™•ì¸ í›„ ìƒˆë¡œê³ ì¹¨ í•´ì£¼ì„¸ìš”.");
            throw new Error("Firebase init failed");
        }

        // -----------------------------------------------------------------
        // [ì¡°ì¹˜ 2 ìˆ˜ì •ë¨] ì´ ë½‘íŒ íšŸìˆ˜ ì‹¤ì‹œê°„ ì§‘ê³„ (ìµœì í™”)
        // -----------------------------------------------------------------
        let unsubscribeTotalPicks; 
        const counterElement = document.getElementById('total-picks-counter');
        const picksCounterContainer = document.getElementById('total-picks-container'); 

        try {
            // 'participants' ì»¬ë ‰ì…˜ ì „ì²´ê°€ ì•„ë‹Œ, 'stats' ì»¬ë ‰ì…˜ì˜ 'counters' ë¬¸ì„œ 1ê°œë§Œ ê°ì‹œí•©ë‹ˆë‹¤.
            const counterDocRef = doc(db, "stats", "counters");
            
            unsubscribeTotalPicks = onSnapshot(counterDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    const totalPicks = data.totalPicks || 0; // 'totalPicks' í•„ë“œ ì‚¬ìš©
                    counterElement.textContent = `ì´ ${totalPicks}íšŒ ë§¤ì¹­ë¨`;
                } else {
                    // ë¬¸ì„œê°€ ì—†ëŠ” ê²½ìš° (ìµœì´ˆ ìƒì„± ì „)
                    counterElement.textContent = "ì§‘ê³„ ì¤‘... (ì¹´ìš´í„° ì—†ìŒ)";
                    console.warn("[Firestore] 'stats/counters' ë¬¸ì„œê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. Firestoreì—ì„œ ìˆ˜ë™ìœ¼ë¡œ ìƒì„±í•´ì£¼ì„¸ìš”.");
                }
            }, (error) => {
                console.error("[Firestore] ì´ íšŸìˆ˜ ì§‘ê³„ ë¦¬ìŠ¤ë„ˆ ì˜¤ë¥˜:", error);
                counterElement.textContent = "ì§‘ê³„ ì˜¤ë¥˜";
            });

        } catch (error) {
            console.error("ì´ íšŸìˆ˜ ì§‘ê³„ ë¦¬ìŠ¤ë„ˆ ì„¤ì • ì‹¤íŒ¨:", error);
            counterElement.textContent = "ì§‘ê³„ ì˜¤ë¥˜";
        }


        // -----------------------------------------------------------------
        // 4. ì „ì—­ ë³€ìˆ˜ ë° ì§ˆë¬¸ ëª©ë¡ (ë³€ê²½ ì—†ìŒ)
        // -----------------------------------------------------------------
        let userOptions = {}; 
        let userAnswers = []; 
        let currentQuestionIndex = 0;
        let resultPageTimer = null; 

        const AI_QUESTIONS = [
            "ëˆ„êµ°ê°€ì™€ í•¨ê»˜ ìˆì„ ë•Œ, ê°€ì¥ í¸ì•ˆí•˜ë‹¤ê³  ëŠë¼ëŠ” ìˆœê°„ì€ ì–¸ì œì¸ê°€ìš”?",
            "ìŠ¤íŠ¸ë ˆìŠ¤ë¥¼ ë°›ì„ ë•Œ, ì£¼ë¡œ ì–´ë–¤ ë°©ì‹ìœ¼ë¡œ í’€ê±°ë‚˜ ëŒ€ì²˜í•˜ë‚˜ìš”?",
            "ë‹¹ì‹ ì´ ìƒê°í•˜ëŠ” 'ì¢‹ì€ ì‚¬ëŒ'ì€ ì–´ë–¤ ì‚¬ëŒì¸ê°€ìš”?"
        ];
        // -----------------------------------------------------------------
        // 5. í˜ì´ì§€ ì „í™˜ ë¡œì§ (ë³€ê²½ ì—†ìŒ)
        // -----------------------------------------------------------------
        const pages = document.querySelectorAll('.page-container');
        const mainContainer = document.getElementById('main-container'); 
        const fsButton = document.getElementById('btn-fullscreen'); 

        function showPage(pageId) {
            
            mainContainer.classList.remove('max-w-4xl'); 
            mainContainer.classList.add('max-w-xl', 'lg:max-w-3xl');

            if (pageId === 'page-welcome') {
                picksCounterContainer.classList.remove('hidden');
                fsButton.classList.remove('hidden'); 
            } else {
                picksCounterContainer.classList.add('hidden');
                fsButton.classList.add('hidden'); 
            }

            pages.forEach(page => {
                if (page.id === pageId) {
                    page.classList.remove('hidden');
                } else {
                    page.classList.add('hidden');
                }
            });
            window.scrollTo(0, 0); 
        }

        if(document.getElementById('page-welcome').classList.contains('hidden') === false) {
             picksCounterContainer.classList.remove('hidden');
        }


        // -----------------------------------------------------------------
        // 6. ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (ë²„íŠ¼ í´ë¦­) (ë³€ê²½ ì—†ìŒ)
        // -----------------------------------------------------------------
        
        document.getElementById('btn-start').addEventListener('click', () => {
            showPage('page-options');
        });

        document.getElementById('btn-fullscreen').addEventListener('click', () => {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen()
                    .catch(err => {
                        console.warn(`ì „ì²´í™”ë©´ ì „í™˜ ì‹¤íŒ¨: ${err.message}`);
                    });
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                }
            }
        });

        document.addEventListener('fullscreenchange', () => {
            const iconExpand = document.getElementById('icon-expand');
            const iconContract = document.getElementById('icon-contract');
            if (document.fullscreenElement) {
                iconExpand.classList.add('hidden');
                iconContract.classList.remove('hidden');
            } else {
                iconExpand.classList.remove('hidden');
                iconContract.classList.add('hidden');
            }
        });

        document.getElementById('btn-submit-options').addEventListener('click', () => {
            const targetGender = document.querySelector('input[name="targetGender"]:checked');
            if (!targetGender) {
                alert("ì°¾ê³  ì‹¶ì€ ìƒëŒ€ì˜ ì„±ë³„ì„ ì„ íƒí•´ì£¼ì„¸ìš”!");
                return;
            }
            
            const targetStudentId = document.querySelector('input[name="targetStudentId"]:checked');
            const targetCount = document.querySelector('input[name="targetCount"]:checked');

            userOptions = {
                gender: targetGender.value,
                studentId: targetStudentId.value, 
                count: parseInt(targetCount.value, 10) 
            };
            
            startAIChat();
        });

        const chatInput = document.getElementById('chat-input');
        const sendButton = document.getElementById('btn-send-answer');
        const charCounter = document.getElementById('char-counter');
        const maxChars = 100;

        sendButton.addEventListener('click', handleAnswerSubmit);
        
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault(); 
                handleAnswerSubmit();
            }
        });

        chatInput.addEventListener('input', () => {
            chatInput.style.height = 'auto';
            chatInput.style.height = (chatInput.scrollHeight) + 'px';

            const currentLength = chatInput.value.length;
            charCounter.textContent = currentLength;
            
            if (currentLength > maxChars) {
                charCounter.parentElement.classList.add('text-red-500');
                charCounter.parentElement.classList.remove('text-gray-400');
            } else {
                charCounter.parentElement.classList.remove('text-red-500');
                charCounter.parentElement.classList.add('text-gray-400');
            }
            sendButton.disabled = (currentLength === 0 || currentLength > maxChars);
        });
        
        document.getElementById('btn-go-home').addEventListener('click', () => {
            
            if (resultPageTimer) {
                clearInterval(resultPageTimer); 
                resultPageTimer = null;
                console.log("íƒ€ì´ë¨¸ ì¤‘ì§€: ì‚¬ìš©ìê°€ ìˆ˜ë™ìœ¼ë¡œ í™ˆ ë³µê·€");
            }

            document.getElementById('auto-home-timer').classList.add('hidden');

            userOptions = {};
            userAnswers = [];
            currentQuestionIndex = 0;
            document.getElementById('chat-window').innerHTML = '';
            document.getElementById('result-cards').innerHTML = '';
            document.getElementById('chat-input').value = '';
            charCounter.textContent = 0;
            charCounter.parentElement.classList.remove('text-red-500');
            charCounter.parentElement.classList.add('text-gray-400');
            sendButton.disabled = true;
            document.querySelectorAll('input[name="targetGender"]').forEach(radio => radio.checked = false);
            document.querySelector('input[name="targetStudentId"][value="all"]').checked = true;
            document.querySelector('input[name="targetCount"][value="1"]').checked = true;

            showPage('page-welcome');
        });

        // -----------------------------------------------------------------
        // 7. AI ì±„íŒ… ë¡œì§ (ë³€ê²½ ì—†ìŒ)
        // -----------------------------------------------------------------

        function startAIChat() {
            currentQuestionIndex = 0;
            userAnswers = [];
            document.getElementById('chat-window').innerHTML = ''; 
            showPage('page-chat');
            askNextQuestion();
        }

        function askNextQuestion() {
            if (currentQuestionIndex < AI_QUESTIONS.length) {
                const question = AI_QUESTIONS[currentQuestionIndex];
                addChatMessage(question, 'ai');
                document.getElementById('chat-input').value = '';
                document.getElementById('chat-input').disabled = false;
                document.getElementById('btn-send-answer').disabled = true; 
                document.getElementById('char-counter').textContent = 0;
                document.getElementById('char-counter').parentElement.classList.remove('text-red-500');
                document.getElementById('char-counter').parentElement.classList.add('text-gray-400');
                const textarea = document.getElementById('chat-input');
                textarea.style.height = 'auto';
            } else {
                startMatching();
            }
        }

        function handleAnswerSubmit() {
            const inputElement = document.getElementById('chat-input');
            const answer = inputElement.value.trim();

            if (answer.length === 0) return; 
            if (answer.length > maxChars) {
                alert("ë‹µë³€ì´ ë„ˆë¬´ ê¹ë‹ˆë‹¤. 100ì ì´ë‚´ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”."); 
                return;
            }

            userAnswers.push(answer);
            addChatMessage(answer, 'user');

            inputElement.value = "Geminiê°€ ë‹¤ìŒ ì§ˆë¬¸ì„ ì¤€ë¹„ì¤‘ì…ë‹ˆë‹¤...";
            inputElement.disabled = true;
            document.getElementById('btn-send-answer').disabled = true; 

            currentQuestionIndex++;
            
            setTimeout(askNextQuestion, 1000);
        }

        function addChatMessage(message, sender) {
            const chatWindow = document.getElementById('chat-window');
            const bubble = document.createElement('div');
            bubble.className = `w-full flex ${sender === 'user' ? 'justify-end' : 'justify-start'}`;
            
            const textElement = document.createElement('p');
            textElement.className = `max-w-[80%] p-3 px-5 shadow-sm text-base ${sender === 'user' ? 'chat-bubble-user' : 'chat-bubble-ai'}`; 
            
            bubble.appendChild(textElement);
            chatWindow.appendChild(bubble);

            if (sender === 'ai') {
                typeMessage(textElement, message, () => {
                    chatWindow.scrollTop = chatWindow.scrollHeight; 
                });
            } else {
                textElement.textContent = message;
                chatWindow.scrollTop = chatWindow.scrollHeight; 
            }
        }

        function typeMessage(element, message, callback) {
            let index = 0;
            element.textContent = ''; 
            const intervalId = setInterval(() => {
                if (index < message.length) {
                    element.textContent += message.charAt(index);
                    index++;
                    const chatWindow = document.getElementById('chat-window');
                    chatWindow.scrollTop = chatWindow.scrollHeight;
                } else {
                    clearInterval(intervalId);
                    if (callback) callback(); 
                }
            }, 50); 
        }

        // -----------------------------------------------------------------
        // 8. AI ë§¤ì¹­ ë¡œì§ (í•µì‹¬)
        // -----------------------------------------------------------------
        
        async function startMatching() {
            showPage('page-loading'); 

            try {
                // [ì¡°ì¹˜ 3 ìˆ˜ì •ë¨] fetchCandidates í•¨ìˆ˜ ìì²´ê°€ ìµœì í™”ë˜ì—ˆìŠµë‹ˆë‹¤.
                const candidates = await fetchCandidates();
                
                if (candidates.length === 0) {
                    alert("ì¡°ê±´ì— ë§ëŠ” ìƒëŒ€ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ì˜µì…˜ì„ ë³€ê²½í•˜ì—¬ ë‹¤ì‹œ ì‹œë„í•´ë³´ì„¸ìš”.");
                    showPage('page-options'); 
                    return;
                }
                
                // [ìˆ˜ì •ë¨] getAINAnalysis í•¨ìˆ˜ê°€ Netlify í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤.
                const topMatches = await getAINAnalysis(candidates);
                
                displayResults(topMatches);
                
                // [ì¡°ì¹˜ 2 ìˆ˜ì •ë¨] updatePickCounts í•¨ìˆ˜ ìì²´ê°€ ìµœì í™”ë˜ì—ˆìŠµë‹ˆë‹¤.
                await updatePickCounts(topMatches);

                if (resultPageTimer) clearInterval(resultPageTimer); 
                
                let countdown = 60; // (1ë¶„ ìœ ì§€)
                const timerElement = document.getElementById('auto-home-timer');
                
                timerElement.textContent = `${countdown}ì´ˆ í›„ ë©”ì¸í™”ë©´ìœ¼ë¡œ ëŒì•„ê°‘ë‹ˆë‹¤...`;
                timerElement.classList.remove('hidden');

                resultPageTimer = setInterval(() => {
                    countdown--;
                    if (countdown > 0) {
                        timerElement.textContent = `${countdown}ì´ˆ í›„ ë©”ì¸í™”ë©´ìœ¼ë¡œ ëŒì•„ê°‘ë‹ˆë‹¤...`;
                    } else {
                        clearInterval(resultPageTimer);
                        resultPageTimer = null;
                        console.log("ì¹´ìš´íŠ¸ë‹¤ìš´ ì™„ë£Œ. í™ˆìœ¼ë¡œ ìë™ ë³µê·€í•©ë‹ˆë‹¤.");
                        document.getElementById('btn-go-home').click();
                    }
                }, 1000); 

                showPage('page-result');

            } catch (error) {
                console.error("ë§¤ì¹­ ì‹¤íŒ¨:", error);
                if (error.message.includes("composite index")) {
                     alert(`[ê°œë°œì ì˜¤ë¥˜] Firestore ë³µí•© ì¸ë±ìŠ¤ê°€ í•„ìš”í•©ë‹ˆë‹¤. F12(ì½˜ì†”)ë¥¼ ì—´ì–´ ì˜¤ë¥˜ ë©”ì‹œì§€ì˜ ë§í¬ë¥¼ í´ë¦­í•´ ì¸ë±ìŠ¤ë¥¼ ìƒì„±í•˜ì„¸ìš”.`);
                } else {
                     alert(`ë§¤ì¹­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}. í™ˆìœ¼ë¡œ ëŒì•„ê°‘ë‹ˆë‹¤.`);
                }
                document.getElementById('btn-go-home').click();
            }
        }

        // [ì¡°ì¹˜ 3 ìˆ˜ì •ë¨] 8-1. Firebase í›„ë³´ ê°€ì ¸ì˜¤ê¸° (ì¿¼ë¦¬ ìµœì í™”)
        async function fetchCandidates() {
            const participantsRef = collection(db, "participants");
            const studentIdPref = userOptions.studentId;

            // 1. ê¸°ë³¸ ì¿¼ë¦¬ (ì„±ë³„ í•„í„°ë§)
            let q = query(participantsRef, where("gender", "==", userOptions.gender));

            // 2. í•™ë²ˆ í•„í„°ë§ì„ Firestore ì¿¼ë¦¬ì— ì§ì ‘ ì¶”ê°€
            if (studentIdPref === 'low') {
                // 'in' ì¿¼ë¦¬ëŠ” ìµœëŒ€ 30ê°œê¹Œì§€ ì§€ì›í•©ë‹ˆë‹¤. (["24", "25"]ëŠ” 2ê°œì´ë¯€ë¡œ OK)
                q = query(q, where("studentId", "in", ["24", "25"]));
            } else if (studentIdPref === 'high') {
                // '24'ë³´ë‹¤ ì‘ì€ ë¬¸ìì—´ (ì˜ˆ: "23", "22", "21"...)
                // í•™ë²ˆì´ ìˆ«ìê°€ ì•„ë‹Œ ë¬¸ìì—´ë¡œ ì €ì¥ë˜ì–´ ìˆì–´ì•¼ ì˜¬ë°”ë¥´ê²Œ ì‘ë™í•©ë‹ˆë‹¤.
                q = query(q, where("studentId", "<", "24")); 
            }
            // studentIdPrefê°€ 'all'ì´ë©´ ì¶”ê°€ í•„í„°ë§ì„ í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

            // 3. ìµœì í™”ëœ ì¿¼ë¦¬ ì‹¤í–‰
            // â€» ì°¸ê³ : ì´ ì¿¼ë¦¬ê°€ ì²˜ìŒ ì‹¤íŒ¨í•˜ë©´ ì½˜ì†”ì˜ ì˜¤ë¥˜ ë§í¬ë¥¼ í´ë¦­í•˜ì—¬
            // (gender, studentId) ë³µí•© ì¸ë±ìŠ¤ë¥¼ ìƒì„±í•´ì•¼ í•©ë‹ˆë‹¤.
            const querySnapshot = await getDocs(q);

            const candidates = [];
            querySnapshot.forEach((doc) => {
                const data = doc.data();
                
                // 4. í´ë¼ì´ì–¸íŠ¸ì—ì„œëŠ” 'pickLimit' ê´€ë ¨ í•„í„°ë§ë§Œ ìˆ˜í–‰
                const timesPicked = data.timesPicked || 0; 
                const isPickable = data.pickLimit > 0 && timesPicked < data.pickLimit;
                
                if (isPickable) {
                    // í•™ë²ˆ(studentId) í•„í„°ë§ì€ ì´ë¯¸ Firestoreì—ì„œ ì™„ë£Œë¨
                    candidates.push({
                        id: doc.id,
                        name: data.name,
                        department: data.department,
                        studentId: data.studentId, 
                        contact: data.contact, 
                        q1: data.q1,
                        q2: data.q2,
                        q3: data.q3,
                    });
                }
            });
            
            console.log(`[Firestore] ì¿¼ë¦¬ í•„í„°ë§ëœ í›„ë³´ ${candidates.length}ëª…:`, candidates);
            return candidates;
        }

        // 8-2. Gemini AI ë¶„ì„ ìš”ì²­ (ì˜¤ë¥˜ ì²˜ë¦¬ ìˆ˜ì •ë¨)
        async function getAINAnalysis(candidates) {
            
            // 1. ì„œë²„ í•¨ìˆ˜ì— ë³´ë‚¼ ë°ì´í„°ë§Œ ì¤€ë¹„
            const payload = {
                userAnswers: userAnswers,
                candidates: candidates.map(c => ({ id: c.id, q1: c.q1, q2: c.q2, q3: c.q3 })),
                userOptionsCount: userOptions.count,
                AI_QUESTIONS: AI_QUESTIONS
            };

            let response;
            try {
                console.log("Netlify í•¨ìˆ˜ í˜¸ì¶œ ì‹œì‘... (/.netlify/functions/get-ai-analysis)");
                
                // 2. Google APIê°€ ì•„ë‹Œ, ìš°ë¦¬ Netlify í•¨ìˆ˜ ì£¼ì†Œë¥¼ í˜¸ì¶œ
                response = await fetchWithRetry("/.netlify/functions/get-ai-analysis", {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

            } catch (error) {
                console.error("Netlify í•¨ìˆ˜ í˜¸ì¶œ ì¤‘ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜:", error);
                throw new Error("ë§¤ì¹­ ì„œë²„ì™€ í†µì‹ ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            }

            // [ìˆ˜ì •ë¨] 
            // 'Body is disturbed' ì˜¤ë¥˜ë¥¼ í”¼í•˜ê¸° ìœ„í•´ response.ok ì—¬ë¶€ì— ë”°ë¼
            // ì‘ë‹µ ë³¸ë¬¸ì„ "ë‹¨ í•œ ë²ˆë§Œ" ì½ë„ë¡ ë¡œì§ì„ ìˆ˜ì •í•©ë‹ˆë‹¤.

            if (!response.ok) {
                // 3-A. ì˜¤ë¥˜ ì‘ë‹µ ì²˜ë¦¬
                let errorText = await response.text(); // ì‘ë‹µì„ í…ìŠ¤íŠ¸ë¡œ 'í•œ ë²ˆë§Œ' ì½ìŠµë‹ˆë‹¤.
                let errorMessage = errorText;

                // í…ìŠ¤íŠ¸ê°€ JSON í˜•íƒœì¸ì§€ í™•ì¸
                try {
                    const errorJson = JSON.parse(errorText);
                    if (errorJson.error) {
                        errorMessage = errorJson.error; // { "error": "ë©”ì‹œì§€" } í˜•íƒœ
                    }
                } catch (e) {
                    // JSON íŒŒì‹± ì‹¤íŒ¨. errorMessageëŠ” ì´ë¯¸ text ì›ë³¸ì´ë¯€ë¡œ ê´œì°®ìŒ.
                }

                console.error(`Netlify í•¨ìˆ˜ ì˜¤ë¥˜ ì‘ë‹µ (Status: ${response.status}):`, errorMessage);
                
                if (response.status === 429) {
                     throw new Error("API í• ë‹¹ëŸ‰ì„ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
                }
                throw new Error(`ë§¤ì¹­ ì„œë²„ê°€ ì˜¤ë¥˜ë¥¼ ë°˜í™˜í–ˆìŠµë‹ˆë‹¤: ${errorMessage}`);
            }

            // 3-B. ì„±ê³µ ì‘ë‹µ ì²˜ë¦¬
            let topMatchesFromAI;
            try {
                 topMatchesFromAI = await response.json(); // ì„±ê³µ ì‘ë‹µì„ JSONìœ¼ë¡œ 'í•œ ë²ˆë§Œ' ì½ìŠµë‹ˆë‹¤.
            } catch(e) {
                console.error("Netlify í•¨ìˆ˜ê°€ ë°˜í™˜í•œ JSON íŒŒì‹± ì˜¤ë¥˜:", e);
                throw new Error("ì„œë²„ê°€ ë°˜í™˜í•œ ë°ì´í„° í˜•ì‹ì´ ì˜ëª»ë˜ì—ˆìŠµë‹ˆë‹¤.");
            }

            // 4. ê¸°ì¡´ ë¡œì§ê³¼ ë™ì¼ (í›„ë³´ì ì •ë³´ì™€ AI ë¶„ì„ ê²°ê³¼ ê²°í•©)
            const finalMatches = topMatchesFromAI.map(aiMatch => {
                const originalCandidate = candidates.find(c => c.id === aiMatch.id);
                if (!originalCandidate) return null; 
                
                return {
                    ...originalCandidate, 
                    ...aiMatch 
                };
            }).filter(match => match !== null); 
            
            console.log("ìµœì¢… ë§¤ì¹­ ê²°ê³¼ (ì •ë³´ ê²°í•©ë¨):", finalMatches);
            return finalMatches;
        }
        
        // 8-3. ë„¤íŠ¸ì›Œí¬ ì¬ì‹œë„ (ë³€ê²½ ì—†ìŒ)
        async function fetchWithRetry(url, options, retries = 3, delay = 1000) {
            try {
                const response = await fetch(url, options);
                if ((response.status === 429 || response.status >= 500) && retries > 0) {
                    console.warn(`API ìš”ì²­ ì¬ì‹œë„ (Status: ${response.status})... ${retries - 1}íšŒ ë‚¨ìŒ.`);
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return fetchWithRetry(url, options, retries - 1, delay * 2);
                }
                return response;
            } catch (error) { 
                if (retries > 0) {
                    console.warn(`API ìš”ì²­ ì¬ì‹œë„ (ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜)... ${retries - 1}íšŒ ë‚¨ìŒ.`);
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return fetchWithRetry(url, options, retries - 1, delay * 2);
                }
                throw error; 
            }
        }

        // 8-4. ê²°ê³¼ ì¹´ë“œ ê·¸ë¦¬ê¸° (ë³€ê²½ ì—†ìŒ)
        function displayResults(matches) {
            const container = document.getElementById('result-cards');
            container.innerHTML = ''; 

            if (!matches || matches.length === 0) {
                container.innerHTML = '<p class="text-gray-600 text-center">ë§¤ì¹­ëœ ìƒëŒ€ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</p>';
                return;
            }

            document.getElementById('result-title').textContent = `ğŸ‰ ë§¤ì¹­ ê²°ê³¼! ğŸ‰`;
            container.className = "space-y-4";

            matches.forEach(match => {
                const card = document.createElement('div');
                card.className = 'p-5 bg-white border border-pink-100 rounded-lg shadow-lg';
                
                const formattedPhone = formatPhoneNumber(match.contact);

                card.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-2xl font-bold text-gray-800">${match.name}</h3>
                        <span class="text-xl font-bold text-pink-500">ì¼ì¹˜ìœ¨ ${match.matchScore}%</span>
                    </div>
                    <p class="text-gray-600 mb-4">${match.department} / ${match.studentId}í•™ë²ˆ</p>
                    <p class="text-xl font-semibold text-gray-700 mb-2">ğŸ“ ì—°ë½ì²˜: ${formattedPhone}</p>
                    <div class="mt-4 p-3 bg-gray-50 rounded-md border border-gray-200">
                        <p class="text-sm font-semibold text-pink-600">AIì˜ ë§¤ì¹­ ì´ìœ :</p>
                        <p class="text-gray-700">${match.matchReason}</p>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // 8-4.5. ì „í™”ë²ˆí˜¸ í¬ë§·íŒ… (ë³€ê²½ ì—†ìŒ)
        function formatPhoneNumber(phone) {
            if (!phone) return "ì •ë³´ ì—†ìŒ";
            
            let cleaned = ('' + phone).replace(/\D/g, ''); 
            
            if (cleaned.length === 10 && !cleaned.startsWith('0')) {
                cleaned = '0' + cleaned; 
            }

            if (cleaned.length === 11) {
                return `${cleaned.substring(0, 3)}-${cleaned.substring(3, 7)}-${cleaned.substring(7)}`;
            } else if (cleaned.length === 10) {
                if (cleaned.startsWith('02')) {
                    return `${cleaned.substring(0, 2)}-${cleaned.substring(2, 6)}-${cleaned.substring(6)}`;
                } else {
                    return `${cleaned.substring(0, 3)}-${cleaned.substring(3, 6)}-${cleaned.substring(6)}`;
                }
            }
            
            return phone; 
        }

        // [ì¡°ì¹˜ 2 ìˆ˜ì •ë¨] 8-5. timesPicked ë° ì´ íšŸìˆ˜ ì—…ë°ì´íŠ¸ (ìµœì í™”)
        async function updatePickCounts(matches) {
            // 'stats/counters' ë¬¸ì„œ ì°¸ì¡°
            const counterDocRef = doc(db, "stats", "counters");

            for (const match of matches) {
                try {
                    // 1. ë§¤ì¹­ëœ ì°¸ê°€ìì˜ ë¬¸ì„œ ì°¸ì¡°
                    const participantDocRef = doc(db, "participants", match.id);
                    
                    // 2. í•´ë‹¹ ì°¸ê°€ìì˜ timesPicked 1 ì¦ê°€
                    await updateDoc(participantDocRef, {
                        timesPicked: increment(1) 
                    });

                    // 3. (ì¶”ê°€) 'stats/counters' ë¬¸ì„œì˜ totalPicks 1 ì¦ê°€
                    await updateDoc(counterDocRef, {
                        totalPicks: increment(1)
                    });
                    
                    console.log(`[Firestore] ${match.name}ë‹˜ timesPicked ë° ì´ íšŸìˆ˜ ì—…ë°ì´íŠ¸ ì„±ê³µ`);
                } catch (error) {
                    console.error(`[Firestore] ${match.name}ë‹˜ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:`, error);
                    // í•œ ìª½ì´ ì‹¤íŒ¨í•´ë„ ê³„ì† ì§„í–‰ (ìµœì•…ì˜ ê²½ìš° ì¹´ìš´í„°ê°€ 1~2ê°œ ì•ˆ ë§ì„ ìˆ˜ ìˆìœ¼ë‚˜, ë§¤ì¹­ ìì²´ëŠ” ì„±ê³µ)
                }
            }
        }

    </script>
</body>
</html>